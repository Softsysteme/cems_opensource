<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="xml2json.js"></script>
<!-- 
  `<c8o-service>` provides an API for acessing Convertigo server
  @element c8o-service
  @attribute data 
  @type object
-->
<polymer-element name="c8o-service" attributes="rdata">
  <template>
    <style>
    :host {
      display: none;
    }
    </style>
  </template>
  <script>
  Polymer('c8o-service', {
    ready: function() {
    	C8O.log.debug('c8o-service ready: ');
    	// Prepare JSON to XML converter
    	C8O.x2js = new X2JS();
		var self = this;
   		C8O.addHook("xml_response", function (xml, data) {
    		var jsObject = C8O.x2js.xml2json(xml);
    		self.rdata = jsObject;
		    return true;
  		});
    },
    
    /** 
     * call a Convertigo requestable
     * 
     * @method call
     * @param requestable.
     */
    call: function(requestable) {
      // no service backend, just log the change
      C8O.log.debug('Convertigo server called: ' + requestable);
      
      
      var c8oCallParams = {};
      var re_requestable = new RegExp("^([^.]*)\\.(?:([^.]+)|(?:([^.]+)\\.([^.]+)))$"); // 1: project ; 2: sequence ; 3: connector ; 4: transaction > 1+2 | 1+3+4
      var matches = requestable.match(re_requestable);
      
      if (matches != null) {
          if (matches[1].length) {
              c8oCallParams["__project"] = matches[1];
          }
          if (C8O.isDefined(matches[2])) {
              c8oCallParams["__sequence"] = matches[2];
          } else {
              c8oCallParams["__connector"] = matches[3];
              c8oCallParams["__transaction"] = matches[4];
          }
      } else {
          C8O.log.error("c8o polymer '" + requestable + "' is not valid");
          return false;
      }
      
      C8O.call(c8oCallParams);
    }
  });
  </script>
</polymer-element>